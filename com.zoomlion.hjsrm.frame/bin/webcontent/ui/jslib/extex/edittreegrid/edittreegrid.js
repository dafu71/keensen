Ext.ns("Ext.ux.tree");Ext.ux.tree.TreeGridSorter=Ext.extend(Ext.tree.TreeSorter,{sortClasses:["sort-asc","sort-desc"],sortAscText:"Sort Ascending",sortDescText:"Sort Descending",constructor:function(D,C){if(!Ext.isObject(C)){C={property:D.columns[0].dataIndex||"text",folderSort:true}}Ext.ux.tree.TreeGridSorter.superclass.constructor.apply(this,arguments);this.tree=D;D.on("headerclick",this.onHeaderClick,this);D.ddAppendOnly=true;me=this;this.defaultSortFn=function(N,R){var B=me.dir&&me.dir.toLowerCase()=="desc";var Q=me.property||"text";var O=me.sortType;var S=me.folderSort;var A=me.caseSensitive===true;var P=me.leafAttr||"leaf";if(S){if(N.attributes[P]&&!R.attributes[P]){return 1}if(!N.attributes[P]&&R.attributes[P]){return -1}}var M=O?O(N):(A?N.attributes[Q]:N.attributes[Q].toUpperCase());var T=O?O(R):(A?R.attributes[Q]:R.attributes[Q].toUpperCase());if(M<T){return B?+1:-1}else{if(M>T){return B?-1:+1}else{return 0}}};D.on("afterrender",this.onAfterTreeRender,this,{single:true});D.on("headermenuclick",this.onHeaderMenuClick,this)},onAfterTreeRender:function(){if(this.tree.hmenu){this.tree.hmenu.insert(0,{itemId:"asc",text:this.sortAscText,cls:"xg-hmenu-sort-asc"},{itemId:"desc",text:this.sortDescText,cls:"xg-hmenu-sort-desc"})}this.updateSortIcon(0,"asc")},onHeaderMenuClick:function(D,E,F){if(E==="asc"||E==="desc"){this.onHeaderClick(D,null,F);return false}},onHeaderClick:function(E,H,F){if(E&&!this.tree.headersDisabled){var G=this;G.property=E.dataIndex;G.dir=E.dir=(E.dir==="desc"?"asc":"desc");G.sortType=E.sortType;G.caseSensitive===Ext.isBoolean(E.caseSensitive)?E.caseSensitive:this.caseSensitive;G.sortFn=E.sortFn||this.defaultSortFn;this.tree.root.cascade(function(A){if(!A.isLeaf()){G.updateSort(G.tree,A)}});this.updateSortIcon(F,E.dir)}},updateSortIcon:function(F,H){var E=this.sortClasses;var G=this.tree.innerHd.select("td").removeClass(E);G.item(F).addClass(E[H=="desc"?1:0])}});Ext.tree.ColumnResizer=Ext.extend(Ext.util.Observable,{minWidth:14,constructor:function(B){Ext.apply(this,B);Ext.tree.ColumnResizer.superclass.constructor.call(this)},init:function(B){this.tree=B;B.on("render",this.initEvents,this)},initEvents:function(B){B.mon(B.innerHd,"mousemove",this.handleHdMove,this);this.tracker=new Ext.dd.DragTracker({onBeforeStart:this.onBeforeStart.createDelegate(this),onStart:this.onStart.createDelegate(this),onDrag:this.onDrag.createDelegate(this),onEnd:this.onEnd.createDelegate(this),tolerance:3,autoStart:300});this.tracker.initEl(B.innerHd);B.on("beforedestroy",this.tracker.destroy,this.tracker)},handleHdMove:function(O,N){var P=5,K=O.getPageX(),Q=O.getTarget(".x-treegrid-hd",3,true);if(Q){var M=Q.getRegion(),R=Q.dom.style,L=Q.dom.parentNode;if(K-M.left<=P&&Q.dom!==L.firstChild){var S=Q.dom.previousSibling;while(S&&Ext.fly(S).hasClass("x-treegrid-hd-hidden")){S=S.previousSibling}if(S){this.activeHd=Ext.get(S);R.cursor=Ext.isWebKit?"e-resize":"col-resize"}}else{if(M.right-K<=P){var T=Q.dom;while(T&&Ext.fly(T).hasClass("x-treegrid-hd-hidden")){T=T.previousSibling}if(T){this.activeHd=Ext.get(T);R.cursor=Ext.isWebKit?"w-resize":"col-resize"}}else{delete this.activeHd;R.cursor=""}}}},onBeforeStart:function(B){this.dragHd=this.activeHd;return !!this.dragHd},onStart:function(D){this.tree.headersDisabled=true;this.proxy=this.tree.body.createChild({cls:"x-treegrid-resizer"});this.proxy.setHeight(this.tree.body.getHeight());var C=this.tracker.getXY()[0];this.hdX=this.dragHd.getX();this.hdIndex=this.tree.findHeaderIndex(this.dragHd);this.proxy.setX(this.hdX);this.proxy.setWidth(C-this.hdX);this.maxWidth=this.tree.outerCt.getWidth()-this.tree.innerBody.translatePoints(this.hdX).left},onDrag:function(D){var C=this.tracker.getXY()[0];this.proxy.setWidth((C-this.hdX).constrain(this.minWidth,this.maxWidth))},onEnd:function(E){var F=this.proxy.getWidth(),D=this.tree;this.proxy.remove();delete this.dragHd;D.columns[this.hdIndex].width=F;D.updateColumnWidths();setTimeout(function(){D.headersDisabled=false},100)}});Ext.ux.tree.TreeGridNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{isTreeGridNodeUI:true,renderElements:function(R,V,T,L){var P=R.getOwnerTree(),U=P.columns,N=U[0],M,S,Q;this.indentMarkup=R.parentNode?R.parentNode.ui.getChildIndent():"";S=['<tbody class="x-tree-node">','<tr ext:tree-node-id="',R.id,'" class="x-tree-node-el x-tree-node-leaf ',V.cls,'">','<td class="x-treegrid-col">','<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow">','<img src="',V.icon||this.emptyIcon,'" class="x-tree-node-icon',(V.icon?" x-tree-node-inline-icon":""),(V.iconCls?" "+V.iconCls:""),'" unselectable="on">','<a hidefocus="on" class="x-tree-node-anchor" href="',V.href?V.href:"#",'" tabIndex="1" ',V.hrefTarget?' target="'+V.hrefTarget+'"':"",">",'<span unselectable="on">',(N.tpl?N.tpl.apply(V):V[N.dataIndex]||N.text),"</span></a>","</td>"];for(M=1,Q=U.length;M<Q;M++){N=U[M];S.push('<td class="x-treegrid-col ',(N.cls?N.cls:""),'">','<div unselectable="on" class="x-treegrid-text"',(N.align?' style="text-align: '+N.align+';"':""),">",(N.tpl?N.tpl.apply(V):V[N.dataIndex]),"</div>","</td>")}S.push('</tr><tr class="x-tree-node-ct"><td colspan="',U.length,'">','<table class="x-treegrid-node-ct-table" cellpadding="0" cellspacing="0" style="table-layout: fixed; display: none; width: ',P.innerCt.getWidth(),'px;"><colgroup>');for(M=0,Q=U.length;M<Q;M++){S.push('<col style="width: ',(U[M].hidden?0:U[M].width),'px;" />')}S.push("</colgroup></table></td></tr></tbody>");if(L!==true&&R.nextSibling&&R.nextSibling.ui.getEl()){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",R.nextSibling.ui.getEl(),S.join(""))}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",T,S.join(""))}this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1].firstChild.firstChild;var O=this.elNode.firstChild.childNodes;this.indentNode=O[0];this.ecNode=O[1];this.iconNode=O[2];this.anchor=O[3];this.textNode=O[3].firstChild},animExpand:function(B){this.ctNode.style.display="";Ext.ux.tree.TreeGridNodeUI.superclass.animExpand.call(this,B)}});Ext.ux.tree.TreeGridRootNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{isTreeGridNodeUI:true,render:function(){if(!this.rendered){this.wrap=this.ctNode=this.node.ownerTree.innerCt.dom;this.node.expanded=true}if(Ext.isWebKit){var B=this.ctNode;B.style.tableLayout=null;(function(){B.style.tableLayout="fixed"}).defer(1)}},destroy:function(){if(this.elNode){Ext.dd.Registry.unregister(this.elNode.id)}delete this.node},collapse:Ext.emptyFn,expand:Ext.emptyFn});(function(){Ext.override(Ext.list.Column,{init:function(){var C=Ext.data.Types,D=this.sortType;if(this.type){if(Ext.isString(this.type)){this.type=Ext.data.Types[this.type.toUpperCase()]||C.AUTO}}else{this.type=C.AUTO}if(Ext.isString(D)){this.sortType=Ext.data.SortTypes[D]}else{if(Ext.isEmpty(D)){this.sortType=this.type.sortType}}}});Ext.tree.Column=Ext.extend(Ext.list.Column,{});Ext.tree.NumberColumn=Ext.extend(Ext.list.NumberColumn,{});Ext.tree.DateColumn=Ext.extend(Ext.list.DateColumn,{});Ext.tree.BooleanColumn=Ext.extend(Ext.list.BooleanColumn,{});Ext.tree.DictColumn=Ext.extend(Ext.list.Column,{constructor:function(B){_data=[];B.tpl=B.tpl||new Ext.XTemplate("{"+B.dataIndex+":this.format}");B.tpl.format=function(D){_data=B.dictData;for(var A=0;A<_data.length;A++){if(D===_data[A].DICTID){return _data[A].DICTNAME}if(D===""||D===null||D===undefined){return""}}};Ext.tree.DictColumn.superclass.constructor.call(this,B)}});Ext.reg("tgcolumn",Ext.tree.Column);Ext.reg("tgnumbercolumn",Ext.tree.NumberColumn);Ext.reg("tgdatecolumn",Ext.tree.DateColumn);Ext.reg("tgbooleancolumn",Ext.tree.BooleanColumn);Ext.reg("tgdictcolumn",Ext.tree.DictColumn)})();Ext.ux.tree.TreeGrid=Ext.extend(Ext.tree.TreePanel,{rootVisible:false,useArrows:true,lines:false,borderWidth:Ext.isBorderBox?0:2,cls:"x-treegrid",columnResize:true,enableSort:true,reserveScrollOffset:true,enableHdMenu:true,columnsText:"Columns",initComponent:function(){if(!this.root){this.root=new Ext.tree.AsyncTreeNode({text:"Root"})}var D=this.loader;if(!D){D=new Ext.ux.tree.TreeGridLoader({dataUrl:this.dataUrl,requestMethod:this.requestMethod,store:this.store})}else{if(Ext.isObject(D)&&!D.load){D=new Ext.ux.tree.TreeGridLoader(D)}else{if(D){D.createNode=function(A){if(!A.uiProvider){A.uiProvider=Ext.ux.tree.TreeGridNodeUI}return Ext.tree.TreeLoader.prototype.createNode.call(this,A)}}}}this.loader=D;Ext.ux.tree.TreeGrid.superclass.initComponent.call(this);this.initColumns();if(this.enableSort){this.treeGridSorter=new Ext.ux.tree.TreeGridSorter(this,this.enableSort)}if(this.columnResize){this.colResizer=new Ext.tree.ColumnResizer(this.columnResize);this.colResizer.init(this)}var C=this.columns;if(!this.internalTpl){this.internalTpl=new Ext.XTemplate('<div class="x-grid3-header">','<div class="x-treegrid-header-inner">','<div class="x-grid3-header-offset">','<table cellspacing="0" cellpadding="0" border="0"><colgroup><tpl for="columns"><col /></tpl></colgroup>','<thead><tr class="x-grid3-hd-row">','<tpl for="columns">','<td class="x-grid3-hd x-grid3-cell x-treegrid-hd" style="text-align: {align};" id="',this.id,'-xlhd-{#}">','<div class="x-grid3-hd-inner x-treegrid-hd-inner" unselectable="on">',this.enableHdMenu?'<a class="x-grid3-hd-btn" href="#"></a>':"",'{header}<img class="x-grid3-sort-icon" src="',Ext.BLANK_IMAGE_URL,'" />',"</div>","</td></tpl>","</tr></thead>","</div></table>","</div></div>","</div>",'<div class="x-treegrid-root-node">','<table class="x-treegrid-root-table" cellpadding="0" cellspacing="0" style="table-layout: fixed;"></table>',"</div>")}if(!this.colgroupTpl){this.colgroupTpl=new Ext.XTemplate('<colgroup><tpl for="columns"><col style="width: {width}px"/></tpl></colgroup>')}},initColumns:function(){var H=this.columns,I=H.length,G=[],J,F;for(J=0;J<I;J++){F=H[J];if(!F.isColumn){F.xtype=F.xtype?(/^tg/.test(F.xtype)?F.xtype:"tg"+F.xtype):"tgcolumn";F=Ext.create(F)}F.init(this);G.push(F);if(this.enableSort!==false&&F.sortable!==false){F.sortable=true;this.enableSort=true}}this.columns=G},onRender:function(){Ext.tree.TreePanel.superclass.onRender.apply(this,arguments);this.el.addClass("x-treegrid");this.outerCt=this.body.createChild({cls:"x-tree-root-ct x-treegrid-ct "+(this.useArrows?"x-tree-arrows":this.lines?"x-tree-lines":"x-tree-no-lines")});this.internalTpl.overwrite(this.outerCt,{columns:this.columns});this.mainHd=Ext.get(this.outerCt.dom.firstChild);this.innerHd=Ext.get(this.mainHd.dom.firstChild);this.innerBody=Ext.get(this.outerCt.dom.lastChild);this.innerCt=Ext.get(this.innerBody.dom.firstChild);this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});if(this.hideHeaders){this.header.dom.style.display="none"}else{if(this.enableHdMenu!==false){this.hmenu=new Ext.menu.Menu({id:this.id+"-hctx"});if(this.enableColumnHide!==false){this.colMenu=new Ext.menu.Menu({id:this.id+"-hcols-menu"});this.colMenu.on({scope:this,beforeshow:this.beforeColMenuShow,itemclick:this.handleHdMenuClick});this.hmenu.add({itemId:"columns",hideOnClick:false,text:this.columnsText,menu:this.colMenu,iconCls:"x-cols-icon"})}this.hmenu.on("itemclick",this.handleHdMenuClick,this)}}},setRootNode:function(B){B.attributes.uiProvider=Ext.ux.tree.TreeGridRootNodeUI;B=Ext.ux.tree.TreeGrid.superclass.setRootNode.call(this,B);if(this.innerCt){this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns})}return B},clearInnerCt:function(){if(Ext.isIE){var B=this.innerCt.dom;while(B.firstChild){B.removeChild(B.firstChild)}}else{Ext.ux.tree.TreeGrid.superclass.clearInnerCt.call(this)}},initEvents:function(){Ext.ux.tree.TreeGrid.superclass.initEvents.apply(this,arguments);this.mon(this.innerBody,"scroll",this.syncScroll,this);this.mon(this.innerHd,"click",this.handleHdDown,this);this.mon(this.mainHd,{scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut})},onResize:function(I,L){Ext.ux.tree.TreeGrid.superclass.onResize.apply(this,arguments);var K=this.innerBody.dom;var G=this.innerHd.dom;if(!K){return}if(Ext.isNumber(L)){K.style.height=this.body.getHeight(true)-G.offsetHeight+"px"}if(Ext.isNumber(I)){var J=Ext.num(this.scrollOffset,Ext.getScrollBarWidth());if(this.reserveScrollOffset||((K.offsetWidth-K.clientWidth)>10)){this.setScrollOffset(J)}else{var H=this;setTimeout(function(){H.setScrollOffset(K.offsetWidth-K.clientWidth>10?J:0)},10)}}},updateColumnWidths:function(){var Q=this.columns,J=Q.length,R=this.outerCt.query("colgroup"),N=R.length,P,K,O,L;for(O=0;O<J;O++){P=Q[O];for(L=0;L<N;L++){K=R[L];K.childNodes[O].style.width=(P.hidden?0:P.width)+"px"}}for(O=0,R=this.innerHd.query("td"),len=R.length;O<len;O++){P=Ext.fly(R[O]);if(Q[O]&&Q[O].hidden){P.addClass("x-treegrid-hd-hidden")}else{P.removeClass("x-treegrid-hd-hidden")}}var M=this.getTotalColumnWidth();Ext.fly(this.innerHd.dom.firstChild).setWidth(M+(this.scrollOffset||0));this.outerCt.select("table").setWidth(M);this.syncHeaderScroll()},getVisibleColumns:function(){var E=[],F=this.columns,G=F.length,H;for(H=0;H<G;H++){if(!F[H].hidden){E.push(F[H])}}return E},getTotalColumnWidth:function(){var F=0;for(var H=0,G=this.getVisibleColumns(),E=G.length;H<E;H++){F+=G[H].width}return F},setScrollOffset:function(B){this.scrollOffset=B;this.updateColumnWidths()},handleHdDown:function(P,O){var M=P.getTarget(".x-treegrid-hd");if(M&&Ext.fly(O).hasClass("x-grid3-hd-btn")){var L=this.hmenu.items,J=this.columns,K=this.findHeaderIndex(M),N=J[K],I=N.sortable;P.stopEvent();Ext.fly(M).addClass("x-grid3-hd-menu-open");this.hdCtxIndex=K;this.fireEvent("headerbuttonclick",L,N,M,K);this.hmenu.on("hide",function(){Ext.fly(M).removeClass("x-grid3-hd-menu-open")},this,{single:true});this.hmenu.show(O,"tl-bl?")}else{if(M){var K=this.findHeaderIndex(M);this.fireEvent("headerclick",this.columns[K],M,K)}}},handleHdOver:function(F,G){var E=F.getTarget(".x-treegrid-hd");if(E&&!this.headersDisabled){index=this.findHeaderIndex(E);this.activeHdRef=G;this.activeHdIndex=index;var H=Ext.get(E);this.activeHdRegion=H.getRegion();H.addClass("x-grid3-hd-over");this.activeHdBtn=H.child(".x-grid3-hd-btn");if(this.activeHdBtn){this.activeHdBtn.dom.style.height=(E.firstChild.offsetHeight-1)+"px"}}},handleHdOut:function(F,D){var E=F.getTarget(".x-treegrid-hd");if(E&&(!Ext.isIE||!F.within(E,true))){this.activeHdRef=null;Ext.fly(E).removeClass("x-grid3-hd-over");E.style.cursor=""}},findHeaderIndex:function(E){E=E.dom||E;var F=E.parentNode.childNodes;for(var H=0,G;G=F[H];H++){if(G==E){return H}}return -1},beforeColMenuShow:function(){var G=this.columns,H=G.length,F,E;this.colMenu.removeAll();for(F=1;F<H;F++){E=G[F];if(E.hideable!==false){this.colMenu.add(new Ext.menu.CheckItem({itemId:"col-"+F,text:E.header,checked:!E.hidden,hideOnClick:false,disabled:E.hideable===false}))}}},handleHdMenuClick:function(F){var D=this.hdCtxIndex,E=F.getItemId();if(this.fireEvent("headermenuclick",this.columns[D],E,D)!==false){D=E.substr(4);if(D>0&&this.columns[D]){this.setColumnVisible(D,!F.checked)}}return true},setColumnVisible:function(C,D){this.columns[C].hidden=!D;this.updateColumnWidths()},scrollToTop:function(){this.innerBody.dom.scrollTop=0;this.innerBody.dom.scrollLeft=0},syncScroll:function(){this.syncHeaderScroll();var B=this.innerBody.dom;this.fireEvent("bodyscroll",B.scrollLeft,B.scrollTop)},syncHeaderScroll:function(){var B=this.innerBody.dom;this.innerHd.dom.scrollLeft=B.scrollLeft;this.innerHd.dom.scrollLeft=B.scrollLeft},registerNode:function(B){Ext.ux.tree.TreeGrid.superclass.registerNode.call(this,B);if(!B.uiProvider&&!B.isRoot&&!B.ui.isTreeGridNodeUI){B.ui=new Ext.ux.tree.TreeGridNodeUI(B)}}});Ext.reg("treegrid",Ext.ux.tree.TreeGrid);Ext.ux.tree.TreeRowEditor=Ext.extend(Ext.Panel,{hidden:true,floating:true,shadow:false,layout:"hbox",cls:"x-small-editor",buttonAlign:"center",baseCls:"x-row-editor",elements:"header,footer,body",frameWidth:5,buttonPad:3,monitorValid:true,focusDelay:250,saveText:"Save",cancelText:"Cancel",adjustHeight:35,adjustButtonHeight:7,columnButton:true,defaults:{normalWidth:true},initComponent:function(){if(this.columnButton){this.adjustHeight=this.adjustButtonHeight;this.buttonWidth=this.buttonWidth||50}else{this.buttonWidth=this.buttonWidth||this.minButtonWidth}Ext.ux.tree.TreeRowEditor.superclass.initComponent.call(this);this.addEvents("beforeedit","canceledit","validateedit","afteredit")},init:function(B){this.tree=B;this.ownerCt=B;Ext.applyIf(B,{editNode:this.editNode.createDelegate(this)});B.on({scope:this,beforedestroy:this.beforeDestroy,destroy:this.destroy,bodyscroll:{buffer:250,fn:this.positionButtons}})},beforeDestroy:function(){this.stopEditing(false);this.node=null;Ext.destroy(this.saveBtn,this.cancelBtn);if(this.btns){Ext.destroy(this.btns)}},refreshFields:function(){this.initFields();this.verifyLayout()},isDirty:function(){var B;this.items.each(function(A){if(String(this.values[A.id])!==String(A.getValue())){B=true;return false}},this);return B},startEditing:function(f,W){if(this.editing){return}if(this.fireEvent("beforeedit",f)!==false){this.editing=true;var d=this.tree,V=d.innerBody;this.node=f;this.values={};if(!this.rendered){this.render(V)}var c=d.innerCt.getWidth();this.setSize(c);if(!this.initialized){this.initFields()}var a=d.columns,e,U=this.items.items,X,R;for(var Q=0,b=a.length;Q<b;Q++){e=a[Q],X=U[Q];if(!e.buttons&&this.isField(X)){R=this.preEditValue(f,e.dataIndex);X.setValue(R);this.values[X.id]=Ext.isEmpty(R)?"":R}}this.verifyLayout(f,true);var Y=Ext.fly(f.ui.elNode).getXY(),Z=Ext.fly(f.ui.elNode).getHeight(),T=V.getXY()[1]+V.getHeight();var S=Y[1]+Z+this.adjustHeight;if(S>T){V.scroll("b",S);Y=Ext.fly(f.ui.elNode).getXY();S=Y[1]+Z+this.adjustHeight;if(S>T){Y[1]=T-Z-this.adjustHeight}}if(!this.isVisible()){this.setPagePosition(Y)}else{this.el.setXY(Y,{duration:0.15})}if(!this.isVisible()){this.show().doLayout()}if(W!==false){this.doFocus.defer(this.focusDelay,this)}}},stopEditing:function(X){this.editing=false;if(!this.isVisible()){return}if(X===false||!this.isValid()){this.hide();this.fireEvent("canceledit",this.node);return}var P={},T=this.node,W=false,R=this.tree.columns,O,M=this.items.items;for(var U=0,S=R.length;U<S;U++){O=R[U];if(!O.hidden&&!O.buttons){var Q=O.dataIndex;var N=T.attributes[Q],V=this.postEditValue(M[U].getValue(),N,T,Q);if(String(N)!==String(V)){P[Q]=V;W=true}}}if(W&&this.fireEvent("validateedit",T,P)!==false){Ext.apply(T.attributes,P);Ext.iterate(P,function(D,E){var C=0,B;for(var F=0,A=R.length;F<A;F++){B=R[F];if(B.dataIndex==D){C=F;break}}if(C==0){T.ui.textNode.innerHTML=B.tpl?B.tpl.apply(T.attributes):E}else{T.ui.elNode.childNodes[C].firstChild.innerHTML=B.tpl?B.tpl.apply(T.attributes):E}});this.fireEvent("afteredit",T,P)}this.hide()},verifyLayout:function(O,L){if(this.el&&(this.isVisible()||L===true)){var M=O.ui.elNode;this.setSize(Ext.fly(M).getWidth(),Ext.isIE?Ext.fly(M).getHeight()+9:undefined);var Q=this.tree.columns,K=this.items.items,N;for(var R=0,J=Q.length;R<J;R++){N=K[R];if(N&&this.isField(N)){var P=0;if(R===(J-1)){P+=3}else{P+=1}N.setWidth(Q[R].width-P)}}this.doLayout();this.positionButtons()}},slideHide:function(){this.hide()},initFields:function(){var G=this.tree.columns,K=Ext.layout.ContainerLayout.prototype.parseMargins;this.removeAll(false);for(var J=0,H=G.length;J<H;J++){var I=G[J],L=I.editor;if(this.columnButton){if(J==H-1){this.cancelBtn.margins=K("0 0 2 2");this.add([this.saveBtn,this.cancelBtn]);continue}else{if(I.buttons){L=new Ext.BoxComponent()}}}else{if(I.buttons){continue}}if(!L){L=I.displayEditor||new Ext.form.DisplayField()}if(J==0){L.margins=K("0 1 2 1")}else{if(J==H-1){L.margins=K("0 0 2 1")}else{L.margins=K("0 1 2")}}L.setWidth(I.width);L.column=I;if(L.ownerCt!==this){L.on("specialkey",this.onKey,this)}this.insert(J,L)}this.initialized=true},onKey:function(C,D){if(D.getKey()===D.ENTER){this.stopEditing(true);D.stopPropagation()}},editNode:function(B){this.startEditing(B,true)},onRender:function(){Ext.ux.tree.TreeRowEditor.superclass.onRender.apply(this,arguments);this.el.swallowEvent(["keydown","keyup","keypress"]);this.saveBtn=new Ext.Button({ref:"saveBtn",itemId:"saveBtn",text:this.saveText,width:this.buttonWidth,handler:this.stopEditing.createDelegate(this,[true])});this.cancelBtn=new Ext.Button({text:this.cancelText,width:this.buttonWidth,handler:this.stopEditing.createDelegate(this,[false])});if(!this.columnButton){this.btns=new Ext.Panel({baseCls:"x-plain",cls:"x-btns",elements:"body",layout:"table",width:(this.buttonWidth*2)+(this.frameWidth*2)+(this.buttonPad*4),items:[this.saveBtn,this.cancelBtn]});this.btns.render(this.bwrap)}},afterRender:function(){Ext.ux.tree.TreeRowEditor.superclass.afterRender.apply(this,arguments);this.positionButtons();if(this.monitorValid){this.startMonitoring()}},onShow:function(){if(this.monitorValid){this.startMonitoring()}Ext.ux.tree.TreeRowEditor.superclass.onShow.apply(this,arguments)},onHide:function(){Ext.ux.tree.TreeRowEditor.superclass.onHide.apply(this,arguments);this.stopMonitoring()},positionButtons:function(){if(this.btns){var F=this.tree,J=this.el.dom.clientHeight,I=F.innerBody.dom.scrollLeft,H=this.btns.getWidth(),G=F.getWidth();this.btns.el.shift({left:(G/2)-(H/2)+I,top:J-2,stopFx:true,duration:0.2})}},preEditValue:function(D,E){var F=D.attributes[E];return this.autoEncode&&typeof F==="string"?Ext.util.Format.htmlDecode(F):F},postEditValue:function(G,H,F,E){return this.autoEncode&&typeof G=="string"?Ext.util.Format.htmlEncode(G):G},doFocus:function(){if(this.isVisible()){var E=this.tree.columns,G;for(var H=0,F=E.length;H<F;H++){G=E[H];if(!G.hidden&&G.editor){G.editor.focus();break}}}},startMonitoring:function(){if(!this.bound&&this.monitorValid){this.bound=true;Ext.TaskMgr.start({run:this.bindHandler,interval:this.monitorPoll||200,scope:this})}},stopMonitoring:function(){this.bound=false},isValid:function(){var B=true;this.items.each(function(A){if(this.isField(A)&&!A.isValid(true)){B=false;return false}},this);return B},isField:function(B){return !!B.setValue&&!!B.getValue&&!!B.markInvalid&&!!B.clearInvalid},bindHandler:function(){if(!this.bound){return false}var B=this.isValid();this.saveBtn.setDisabled(!B);this.fireEvent("validation",this,B)}});Ext.preg("ptreeroweditor",Ext.ux.tree.TreeRowEditor);Ext.ux.tree.EditTreeGrid=Ext.extend(Ext.ux.tree.TreeGrid,{idProperty:"id",enableSort:false,enableHdMenu:false,highlightColor:"#d9e8fb",depth:Number.MAX_VALUE,rowEdit:true,delConfirm:"提示",delConfirmMsg:"确定删除此节点吗，子结点也将删除?",isTreeEditor:true,initComponent:function(){this.enableHdMenu=false;if(this.rowEdit){this.animate=false;this.editor=new Ext.ux.tree.TreeRowEditor({listeners:{scope:this,canceledit:this.cancelEdit,afteredit:this.saveNode}});this.plugins=this.plugins||[];this.plugins.push(this.editor)}this.addEvents("removeNode","saveNode");Ext.ux.tree.EditTreeGrid.superclass.initComponent.call(this)},beforeDestroy:function(){Ext.destroy(this.editor);Ext.ux.tree.EditTreeGrid.superclass.beforeDestroy.call(this)},initColumns:function(){var K=this.columns,H=K.length,G=[],L,I,J;for(L=0;L<H;L++){I=K[L];if(!I.isColumn){I.xtype=I.xtype?(/^tg/.test(I.xtype)?I.xtype:"tg"+I.xtype):"tgcolumn";if(I.buttons){I.buttons=Ext.isArray(I.buttons)?I.buttons:[I.buttons];I.buttonIconCls=Ext.isDefined(I.buttonIconCls)?(Ext.isArray(I.buttonIconCls)?I.buttonIconCls:[I.buttonIconCls]):[];I.buttonText=Ext.isDefined(I.buttonText)?(Ext.isArray(I.buttonText)?I.buttonText:[I.buttonText]):[];I.buttonTips=Ext.isDefined(I.buttonTips)?(Ext.isArray(I.buttonTips)?I.buttonTips:[I.buttonTips]):[];if(this.rowEdit){I.buttonHandler=[]}else{I.buttonHandler=I.buttonHandler||[];I.buttonHandler=Ext.isArray(I.buttonHandler)?I.buttonHandler:[I.buttonHandler]}J=[];Ext.each(I.buttons,function(B,A){B=Ext.util.Format.lowercase(B);J.push('<div gridbtn="',B,'" class="x-treegrid-button-item x-toolbar"></div>');if(this.rowEdit){I.buttonHandler.push(this[B+"Node"])}},this);I.tpl=new Ext.XTemplate(J);I.dataIndex=this.idProperty;I.editable=false}I=Ext.create(I)}I.init(this);G.push(I);if(this.enableSort!==false&&I.sortable!==false){I.sortable=true;this.enableSort=true}}this.columns=G},updateColumnWidths:function(){var Q=this.columns,J=Q.length,R=this.outerCt.query("colgroup"),N=R.length,P,K,O,L;for(O=0;O<J;O++){P=Q[O];for(L=0;L<N;L++){K=R[L];K.childNodes[O].style.width=(P.hidden?0:P.width)+"px"}}for(O=0,R=this.innerHd.query("td"),len=R.length;O<len;O++){P=Ext.fly(R[O]);if(Q[O]&&Q[O].hidden){P.addClass("x-treegrid-hd-hidden")}else{P.removeClass("x-treegrid-hd-hidden")}}var M=this.getTotalColumnWidth();Ext.fly(this.innerHd.dom.firstChild).setWidth(M+(this.scrollOffset||0));this.outerCt.select("table").each(function(C,B,A){if(!C.hasClass("x-btn")){C.setWidth(M)}},this);this.syncHeaderScroll()},addNode:function(N){N.expand(false);if(this.editor.editing||N.getDepth()+1>this.depth){return}var L={_isNewTreeGridNode:true};L[this.idProperty]="";var K=this.columns,H=K.length,I;for(i=0;i<H;i++){I=K[i];if(I.dataIndex){L[I.dataIndex]=""}}var M=new Ext.tree.TreeNode(L);if(N.isLeaf()){N.leaf=false}else{if(N.lastChild){var J=this.getButton(N.lastChild,"degrade");if(J){J.enable()}}}N.expand(false,false,function(){N.appendChild(M);Ext.fly(M.ui.elNode).highlight(this.highlightColor);this.editNode(M)},this)},updateNode:function(B){if(this.editor.editing){return}this.editNode(B)},cancelEdit:function(D){if(D.attributes._isNewTreeGridNode){var F=D.parentNode;if(F.childNodes.length==1){F.leaf=true}D.remove();if(F.childNodes.length<1){this.updateLeafIcon(F)}else{var E=this.getButton(F.lastChild,"degrade");if(E){E.disable()}}}},saveNode:function(L,H){var I=this.fireEvent("saveNode",L,H);if(!I){return}Ext.fly(L.ui.elNode).highlight(this.highlightColor);var G={},K={node:L,changes:H};Ext.applyIf(G,L.attributes);G.parentNodeId=L.parentNode.attributes.id;G.parentNodeDwdm=L.parentNode.attributes.dwdm;var J=this.columns;Ext.iterate(H,function(C,A){var B=0,E;for(var D=0,F=J.length;D<F;D++){E=J[D];if(E.dataIndex==C){B=D;break}}Ext.fly(L.ui.elNode.childNodes[B]).addClass("x-grid3-dirty-cell")});this.doRequest(L.attributes._isNewTreeGridNode?"add":"update",this.filterParams(G),this.processSave,K)},processSave:function(H,M){try{var N=M.node,J=M.changes;if(N.attributes._isNewTreeGridNode){var K=Ext.decode(H.responseText);N.attributes._isNewTreeGridNode=false;if(K.id){N.setId(K.id)}if(K[this.idProperty]){N.attributes[this.idProperty]=K[this.idProperty]}}var L=this.columns;Ext.iterate(J,function(F,D){var C=0,E;for(var B=0,A=L.length;B<A;B++){E=L[B];if(E.dataIndex==F){C=B;break}}Ext.fly(N.ui.elNode.childNodes[C]).removeClass("x-grid3-dirty-cell")})}catch(I){}},removeNode:function(L){if(this.editor.editing){return}var I=this.fireEvent("removeNode",L);if(!I){return}var N=L.parentNode,H=L.previousSibling,K=L.nextSibling;if(N.childNodes.length==1){N.leaf=true}L.remove();if(N.childNodes.length<1){this.updateLeafIcon(N)}else{if(H&&H.isLast()){var J=this.getButton(H,"degrade");if(J){J.disable()}}if(K&&K.isFirst()){var M=this.getButton(K,"upgrade");if(M){M.disable()}}}},upgradeNode:function(D){if((this.editor&&this.editor.editing)||D.isFirst()){return}D.parentNode.insertBefore(D,D.previousSibling);if(D.isFirst()){this.getButton(D,"upgrade").disable();this.getButton(D,"degrade").enable();this.getButton(D.nextSibling,"upgrade").enable();if(D.nextSibling.isLast()){this.getButton(D.nextSibling,"degrade").disable()}}else{this.getButton(D,"degrade").enable();this.getButton(D.nextSibling,"upgrade").enable();if(D.nextSibling.isLast()){this.getButton(D.nextSibling,"degrade").disable()}}Ext.fly(D.ui.elNode).highlight(this.highlightColor);var C={id:D.id,parentNodeId:D.parentNode.id};C[this.idProperty]=D.attributes[this.idProperty];this.doRequest("upgrade",this.filterParams(C))},degradeNode:function(D){if((this.editor&&this.editor.editing)||D.isLast()){return}D.parentNode.insertBefore(D,D.nextSibling.nextSibling);if(D.isLast()){this.getButton(D,"upgrade").enable();this.getButton(D,"degrade").disable();if(D.previousSibling.isFirst()){this.getButton(D.previousSibling,"upgrade").disable()}this.getButton(D.previousSibling,"degrade").enable()}else{this.getButton(D,"upgrade").enable();this.getButton(D,"degrade").enable();if(D.previousSibling.isFirst()){this.getButton(D.previousSibling,"upgrade").disable()}this.getButton(D.previousSibling,"degrade").enable()}Ext.fly(D.ui.elNode).highlight(this.highlightColor);var C={id:D.id,parentNodeId:D.parentNode.id};C[this.idProperty]=D.attributes[this.idProperty];this.doRequest("degrade",this.filterParams(C))},doRequest:function(H,E,G,F){if(!this.requestApi||!this.requestApi[H]){return}E=Ext.apply({requestAction:H},E);F=Ext.applyIf(F||{},{params:E});if(Ext.isString(this.requestApi[H])){F.url=this.requestApi[H]}else{Ext.applyIf(F,this.requestApi[H])}if(G){if(F.success){F.success=G.createDelegate(this).createSequence(F.success)}else{if(F.callback){F.callback=G.createDelegate(this).createSequence(F.callback)}else{F.success=G.createDelegate(this)}}}Ext.Ajax.request(F)},getButton:function(D,C){return D.buttons.get(C)},updateLeafIcon:function(B){if(B.ui.elNode){Ext.fly(B.ui.elNode).replaceClass("x-tree-node-collapsed","x-tree-node-leaf")}},filterParams:function(B){delete B.uiProvider;delete B.iconCls;delete B.loader;delete B.leaf;delete B.children;delete B._isNewTreeGridNode;return B},disableButton:function(D,C){D=Ext.isString(D)?this.getNodeById(D):D;D.disableButton(C)},enableButton:function(D,C){D=Ext.isString(D)?this.getNodeById(D):D;D.enableButton(C)},hideButton:function(D,C){D=Ext.isString(D)?this.getNodeById(D):D;D.hideButton(C)},showButton:function(D,C){D=Ext.isString(D)?this.getNodeById(D):D;D.showButton(C)}});Ext.reg("edittreegrid",Ext.ux.tree.EditTreeGrid);Ext.apply(Ext.ux.tree.TreeGridNodeUI.prototype,{renderElements:function(U,M,W,P){var R=U.getOwnerTree(),T=R.columns,X=T[0],O,N,S;this.indentMarkup=U.parentNode?U.parentNode.ui.getChildIndent():"";N=['<tbody class="x-tree-node">','<tr ext:tree-node-id="',U.id,'" class="x-tree-node-el x-tree-node-leaf ',M.cls,'">','<td class="x-treegrid-col">','<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow">','<img src="',M.icon||this.emptyIcon,'" class="x-tree-node-icon',(M.icon?" x-tree-node-inline-icon":""),(M.iconCls?" "+M.iconCls:""),'" unselectable="on">','<a hidefocus="on" class="x-tree-node-anchor" href="',M.href?M.href:"#",'" tabIndex="1" ',M.hrefTarget?' target="'+M.hrefTarget+'"':"",">",'<span unselectable="on">',(X.tpl?X.tpl.apply(M):M[X.dataIndex]||X.text),"</span></a>","</td>"];for(O=1,S=T.length;O<S;O++){X=T[O];N.push('<td class="x-treegrid-col ',(X.cls?X.cls:""),'">','<div unselectable="on" class="',X.buttons?"x-treegrid-button":"x-treegrid-text",'"',(X.align?' style="text-align: '+X.align+';"':""),">",(X.tpl?X.tpl.apply(M):M[X.dataIndex]),"</div>","</td>")}N.push('</tr><tr class="x-tree-node-ct"><td colspan="',T.length,'">','<table class="x-treegrid-node-ct-table" cellpadding="0" cellspacing="0" style="table-layout: fixed; display: none; width: ',R.innerCt.getWidth(),'px;"><colgroup>');for(O=0,S=T.length;O<S;O++){N.push('<col style="width: ',(T[O].hidden?0:T[O].width),'px;" />')}N.push("</colgroup></table></td></tr></tbody>");if(P!==true&&U.nextSibling&&U.nextSibling.ui.getEl()){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",U.nextSibling.ui.getEl(),N.join(""))}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",W,N.join(""))}if(!U.buttons){U.buttons=new Ext.util.MixedCollection(false,function(A){return A.itemId})}var V=Ext.get(this.wrap);for(O=0,S=T.length;O<S;O++){X=T[O];if(X.buttons){Ext.each(X.buttons,function(B,C){var D=X.buttonHandler[C];var A=new Ext.Button({itemId:B,disabled:(U.attributes[B+"BtnDisabled"]===true)||(B=="add"&&U.getDepth()==R.depth),hidden:(U.attributes[B+"BtnHidden"]===true),iconCls:X.buttonIconCls[C],text:X.buttonText[C],tooltip:X.buttonTips[C],handler:function(){if(B=="remove"){Ext.MessageBox.confirm(R.delConfirm,R.delConfirmMsg,function(E){if(E=="yes"){D.call(R,U)}});return}D.call(R,U)},scope:R});if((B=="upgrade"&&U.isFirst())||(B=="degrade"&&U.isLast())){A.disable()}U.buttons.add(A);A.render(V.child("[gridbtn="+B+"]"))},this)}}this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1].firstChild.firstChild;var Q=this.elNode.firstChild.childNodes;this.indentNode=Q[0];this.ecNode=Q[1];this.iconNode=Q[2];this.anchor=Q[3];this.textNode=Q[3].firstChild}});Ext.apply(Ext.tree.TreeNode.prototype,{disableButton:function(B){if(B=="upgrade"||B=="degrade"){return}if(B){this.buttons.get(B).disable()}},enableButton:function(B){if(B=="upgrade"||B=="degrade"){return}if(B){this.buttons.get(B).enable()}},hideButton:function(B){if(B){this.buttons.get(B).hide()}},showButton:function(B){if(B){this.buttons.get(B).show()}},originalTreeNodeDestroy:Ext.tree.TreeNode.prototype.destroy,destroy:function(B){if(this.buttons){this.buttons.each(function(A){Ext.destroy(A)},this);this.buttons.clear()}this.originalTreeNodeDestroy.call(this,B)}});