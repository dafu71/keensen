var keel={};keel.UploadPanel=function(A){Ext.apply(this,A);this.gp=new Ext.grid.GridPanel({border:false,sm:new Ext.grid.RowSelectionModel({singleSelect:true}),store:new Ext.data.ArrayStore({fields:["id","fileid","filename","type","size","state","percent","filepath"]}),columns:[new Ext.grid.RowNumberer(),{header:"文件名",width:240,sortable:true,dataIndex:"filename",menuDisabled:true},{header:"类型",width:50,sortable:true,dataIndex:"type",menuDisabled:true},{header:"大小",width:60,sortable:true,dataIndex:"size",menuDisabled:true,renderer:this.formatFileSize},{header:"进度",width:150,sortable:true,dataIndex:"percent",menuDisabled:true,renderer:this.formatProgressBar,scope:this},{header:"状态",width:70,sortable:true,dataIndex:"state",menuDisabled:true,renderer:this.formatFileState,scope:this}]});this.setting={returnValue:this.returnValue,upload_url:this.uploadUrl,flash_url:this.flashUrl,file_size_limit:this.fileSize||(1024*50),file_post_name:this.filePostName,file_types:this.fileTypes||"*.*",file_types_description:"All Files",file_upload_limit:"0",post_params:this.postParams||{savePath:"upload\\"},use_query_string:true,debug:false,button_cursor:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,custom_settings:{scope_handler:this},file_queued_handler:this.onFileQueued,swfupload_loaded_handler:function(){},file_dialog_start_handler:function(){},file_dialog_complete_handler:this.onDiaogComplete,upload_start_handler:this.onUploadStart,upload_success_handler:this.onUploadSuccess,swfupload_loaded_handler:function(){},upload_progress_handler:this.uploadProgress,upload_complete_handler:this.onUploadComplete,upload_error_handler:this.onUploadError,file_queue_error_handler:this.onFileError};keel.UploadPanel.superclass.constructor.call(this,{tbar:[{text:"添加文件",ref:"../addBtn"},"-",{text:"开始上传",ref:"../uploadBtn",handler:this.startUpload,scope:this},"-",{text:"停止上传",ref:"../stopBtn",handler:this.stopUpload,scope:this,disabled:true},"-",{text:"删除",scope:this,ref:"../delBtn",handler:this.doDel}],layout:"fit",items:[this.gp],listeners:{"afterrender":function(){var B=this.getTopToolbar().get(0).el.child("em");var C=Ext.id();B.setStyle({position:"relative",display:"block"});B.createChild({tag:"div",id:C});this.swfupload=new SWFUpload(Ext.apply(this.setting,{button_width:B.getWidth(),button_height:B.getHeight(),button_placeholder_id:C}));this.swfupload.uploadStopped=false;Ext.get(this.swfupload.movieName).setStyle({position:"absolute",top:0,left:-2})},scope:this,delay:100}})};keel.adminMgr=Ext.extend(keel.UploadPanel,Ext.Panel,{toggleBtn:function(A){this.addBtn.setDisabled(A);this.uploadBtn.setDisabled(A);this.stopBtn.setDisabled(!A);this.delBtn.setDisabled(A)},onUploadStart:function(C){var B=this.settings.post_params;Ext.apply(B,{fileName:encodeURIComponent(C.name)});var A=this.customSettings.scope_handler;Ext.apply(B,A.postParams);this.setPostParams(B)},startUpload:function(A){if(this.swfupload){if(this.swfupload.getStats().files_queued>0){this.swfupload.uploadStopped=false;this.toggleBtn(true);this.swfupload.startUpload()}}},formatFileSize:function(C,A,B){return Ext.util.Format.fileSize(C)},formatFileState:function(A){switch(A){case -1:return"未上传";break;case -2:return"正在上传";break;case -3:return'<div style="color:red;">上传失败</div>';break;case -4:return"上传成功";break;case -5:return"取消上传";break;default:return A}},formatProgressBar:function(A){var B=this.getTplStr(A);return B},getTplStr:function(B){var A="orange";var C="#008000";return String.format('<div><div style="border:1px solid {0};height:10px;width:{1}px;margin:4px 0px 1px 0px;float:left;"><div style="float:left;background:{2};width:{3}%;height:10px;"><div></div></div></div><div style="text-align:center;float:right;width:40px;margin:3px 0px 1px 0px;height:10px;font-size:12px;">{3}%</div></div>',C,(90),A,B)},onUploadComplete:function(E){var C=this.customSettings.scope_handler;if(E.filestatus==-4){var A=C.gp.store;for(var B=0;B<A.getCount();B++){var D=A.getAt(B);if(D.get("id")==E.id){D.set("percent",100);if(D.get("state")!=-3){D.set("state",E.filestatus)}D.commit()}}}if(this.getStats().files_queued>0&&this.uploadStopped==false){this.startUpload()}else{C.toggleBtn(false)}},onFileQueued:function(C){var B=this.customSettings.scope_handler;var A=new Ext.data.Record({id:C.id,filename:C.name,size:C.size,type:C.type,state:C.filestatus,percent:0,filepath:""});B.gp.getStore().add(A)},onUploadSuccess:function(E,D){var G=this.customSettings.scope_handler;var C=G.gp.store;D=D.toString();if(D.length>0){var B=D.substring(3,D.length-1);B=B.replace(/[\r\n]+/,"");var H=B.split(";");for(var F=0;F<C.getCount();F++){var A=C.getAt(F);if(A.get("id")==E.id){A.set("state",E.filestatus);A.set("fileid",H[0]);A.set("filepath",H[1]);A.commit();G.fireEvent("uploadsuccess",G,A)}}}else{for(var F=0;F<C.getCount();F++){var A=C.getAt(F);if(A.get("id")==E.id){A.set("percent",0);A.set("state",-3);A.commit()}}}},uploadProgress:function(E,B,C){var G=this.customSettings.scope_handler;var F=Math.ceil((B/C)*100);F=F==100?99:F;var A=G.gp.store;for(var D=0;D<A.getCount();D++){var H=A.getAt(D);if(H.get("id")==E.id){H.set("percent",F);H.set("state",E.filestatus);H.commit()}}},onUploadError:function(G,F,A){var E=this.customSettings.scope_handler;var C=E.gp.store;for(var B=0;B<C.getCount();B++){var D=C.getAt(B);if(D.get("id")==G.id){D.set("percent",0);D.set("state",G.filestatus);D.commit()}}},onFileError:function(C,B){switch(B){case -100:A("待上传文件列表数量超限，不能选择！");break;case -110:A("文件太大，不能选择！");break;case -120:A("该文件大小为0，不能选择！");break;case -130:A("该文件类型不可以上传！");break}function A(D){Ext.Msg.show({title:"提示",msg:D,width:280,icon:Ext.Msg.WARNING,buttons:Ext.Msg.OK})}},onDiaogComplete:function(){var A=this.customSettings.scope_handler},stopUpload:function(){if(this.swfupload){this.swfupload.uploadStopped=true;this.swfupload.stopUpload()}},deleteAll:function(){var A=this.gp.store;for(var B=0;B<A.getCount();B++){var C=A.getAt(B);var D=C.get("id");this.swfupload.cancelUpload(D,false)}A.removeAll();this.swfupload.uploadStopped=false},formatDelBtn:function(A){return"<span id='"+A+"'style='color:blue;cursor:pointer' class='link-btn' ext:qtip='移除该文件'><button>删 除</span>"},doDel:function(){var A=this.gp.getSelectionModel().getSelected();if(!A){Ext.Msg.alert("提示","请选择一个文件记录！")}else{if(A.get("fileid")){this.doRemove(A)}else{ds.remove(A)}}this.swfupload.cancelUpload(A.get("id"),false)},doRemove:function(A){var B=this;Ext.Msg.confirm("操作确认","您确实要删除这个文件吗?",function(C){if(C=="yes"){Ext.Ajax.request({url:"com.zoomlion.hjsrm.frame.bclib.file.FileBclib.deleteFile.biz.ext",jsonData:{"fileId":A.get("fileid")},success:function(E){var D=Ext.decode(E.responseText);if(D.success){B.gp.store.remove(A);B.fireEvent("removedsuccess",B,A)}}})}})}});Ext.reg("uploadPanel",keel.UploadPanel);